---
title: Triplet and Pair Wise Network Tutorial
description: Train and test a triplet network on data generated by 3D model from PASCAL3D+ or faces in MultiPIE.
category: example
include_in_docs: true
layout: default
priority: 100
---

# Triplet Network Training with Caffe
This example shows how you can use weight sharing and a triplet loss
function to learn a model using a triplet network in Caffe.

We will assume that you have caffe successfully compiled. If not, please refer
to the [Installation page](../../installation.html).

## Training Data Preparation

For reason that the triplet loss is widely used in multitask training where training samples
are labeled regarding to different aspects, labels of samples are not necessary because
only sequence of training samples matters for triplet loss(such as r1, p1, n1,...,rN ,pN, nN).
1 reference samples and 1 positive sample is fixed in a triplet set, and the
number of negative samples could be set free. So you can use a file list for training
and testing samples. The triplet loss layer could be difined as below:

layer {
  name: "loss"
  type: "TripletLoss"
  bottom: "feat"
  bottom: "label"
  top: "loss"
  triplet_loss_param {
    margin: 0.2
    losstype: 2
    num_negatives: 3
  }
}

where the num_negatives is the number of negative sampels in 1 triplet set,
this set uses 5 samples in total, so the over all training samples must be multiples of 5.

## Introduction to the convert_triplet_data tool

If training based on DB files is needed, here I attach a tool used for converting
binary files including data and label to levelDB database. Triplet loss is based on
particular sequence of training data, so the labels of each sample is used for the
arrangement of training data. This codes convert a set of binary synthetic data
and label(catogory and pose) to levelDB files and arrange them as triplet set consist
of 1 positive sample and 3 negative samples.

You should modify label reading method according to binaryfile in `read_image` function
and conditionals in `convert_dataset` function.

## Models
First, we will define the model that we want to train using the triplet network.
We will use the convolutional net defined in
`./examples/triplet/pascal3d_triplet.prototxt`.

## Define the triplet Network

In this section we will define the triplet network used for training. The
resulting network is defined in
`./examples/triplet/pascal3d_triplet_train_test.prototxt`.

### Adding the Triplet Loss Function

To train the network we will optimize a triplet loss function proposed in:
This cost function is implemented with the `TRIPLET_LOSS` layer,
the num_negatives could be set free:


layer {
  name: "loss"
  type: "TripletLoss"
  bottom: "feat"
  bottom: "sim"
  top: "loss"
  triplet_loss_param {
    margin: 1
    losstype: 0
    num_negatives: 3
  }
}

## Define the Solver

Nothing special needs to be done to the solver besides pointing it at the
correct model file. The solver is defined in
`./examples/triplet/pascal3d_triplet_solver.prototxt`.

## Training and Testing the Model

Training the model is simple after you have written the network definition
protobuf and solver protobuf files. Simply run
`./examples/triplet/train_pascal3d_triplet.sh`:

    ./examples/triplet/train_pascal3d_triplet.sh
